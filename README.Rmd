---
output: github_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
	echo = TRUE,
	message = FALSE,
	warning = FALSE
)
```

# nowcaster <a href='https://github.com/covid19br/nowcaster'><img src='man/figures/nowcaster.png' align="right" width="140" /></a> <a href='https://github.com/covid19br/nowcaster'><img src='man/figures/nowcaster_rev.png' align="right" width="140" /></a>


`nowcaster` is a R package for "nowcasting" epidemiological time-series. Every single system of notification has a intrinsic delay, `nowcaster` can estimate how many counts of any epidemiological data of interest (*i.e.*, daily cases and deaths counts) by fitting a binomial negative model to the time steps of delay between onset date of the event, (*i.e.*, date of first symptoms for cases or date of occurrence of death) and the date of report (*i.e.*, date of notification of the case or death)

`nowcaster` is based on the [`R-INLA`](https://becarioprecario.bitbucket.io/inla-gitbook/index.html) and [`INLA`](https://inla.r-inla-download.org/r-inla.org/doc/inla-manual/inla-manual.pdf) packages for "**I**ntegrated **N**ested **L**aplace **A**pproximation" algorithm to Bayesian inference. `INLA` is an alternative to others methods for Bayesian inference like **MCMC**, An introduction to `INLA` can be found [here](https://becarioprecario.bitbucket.io/inla-gitbook/index.html).

`nowcaster` is build for epidemiological emergency use, it was constructed for the Brazilian Severe Acute Respiratory Illness (SARI) surveillance database (SIVEP-Gripe). 

## Installing


To install `nowcaster` package simply run the code below in R:

```{r install}
devtools::install_github("https://github.com/covid19br/nowcaster")
```

After installing you can load the by typical library:

```{r library}
library(nowcaster)
```

## First example on LazyData

When the package is loaded it disponibilize a LazyData file, `sariBH`, it is a annonymized records of Severe Acute Respiratory Illness notified in the city of Belo Horizonte, since March 2020. To load it basically write:

```{r data-bh}
data<-sragBH
```

And we take a look on the data:

```{r lookup}
head(data)
```

It is a data.frame with 7 variables and 65,404 observations. We will make use of only the first two columns, "DT_SIN_PRI" and "DT_DIGITA" as well the column "Idade" to make age structured nowcasting.

## Non-structured data

Now we call the nowcasting function, it has by default the parametrization to take the data and estimate with a non-structured data form. The estimate fits a $NegBinom(\lambda_{\tau}, t)$ distribution to the cases count at time $t$ with delay $\lambda_\tau$. The distribution is parametrize through assuming a random effect to the delay $\lambda_\tau$ distribution given by a $rw1$ and a random effect to the time $t$ given by a $rw2$. So, the model is:

$$Y_t \sim  1 + rw2(t) + rw1(delay)$$
The call of the function is straightforward, it simply needs a dataset as input, here the `LazyData` loaded in the namespace of the package.

```{r no_age}
nowcasting_bh_no_age<-nowcasting_inla(dataset = data)
head(nowcasting_bh_no_age$total)
```

This calling will return only the nowcasting estimate and its Confidence Interval (CI) for two different Credible interval, `LIb` and `LSb` are the max and min CI, respectively, with credibility of 50% and `LI` and `LS` are the max and min CI, respectively, with credibility of 95%.

`nowcasting_inla` has the option to return the curve out of the window of action of the model, if the `data.by.week` is flagged as ``TRUE` it returns on the third element of the output list the summarized data by week. 

```{r no_age_data}
nowcasting_bh_no_age <- nowcasting_inla(dataset = data, data.by.week = T)
head(nowcasting_bh_no_age$dados)
```

If this third element is groped by and summarized by the onset of symptoms date, here `DT_SIN_PRI` it is the epidemiological curve. To example it we plot the estimate and the epidemiological curve all together.

```{r no_age_plot}
library(ggplot2)

dados_by_week<-nowcasting_bh_no_age$dados %>% 
  filter(DT_SIN_PRI >= (Sys.Date()-270)) %>% 
  group_by(DT_SIN_PRI) %>% 
  summarise(n = n())


nowcasting_bh_no_age$total %>% 
  ggplot(aes(x = dt_event, y = Median, col = 'Median'))+
  geom_line()+
  geom_line(data = dados_by_week, aes(DT_SIN_PRI, y = n))+
  geom_ribbon(aes(ymin = LI, ymax = LS, col = 'IC'), alpha = 0.2)+
  theme_bw()+
  theme(legend.position = "bottom", axis.text.x = element_text(angle = 90))+
  scale_color_manual(values = c('grey90', 'black'), name = '')+
  scale_x_date(date_breaks = '2 weeks', date_labels = '%V/%y', name = 'Date in Weeks')+
  labs(x = '', y = 'Nº Cases')

```


## Structured data, Age

For the structured data the `nowcasting_inla()` fits again a $NegBinom$ distribution to the cases count at time $t$ with delay $\tau$. Differently, from the non-structured case the model now gives random effects to the delay distribution and and time distribution by each of the age-class choosed by the user to break the data. The model has the form now:

$$Y_{t, Age} \sim  1 + Age + rw2(t | Age) + rw1(delay|Age)$$

This new model gives to each of the age classes which the data was divide a model poundering the delay effects and time by each age class at time $t$. Now the model needs a flag indicating which is the column on the dataset which will be used to break the data into age classes and which is the choosed option into which the age classes will be, this is given by the parameters `age_col` and `bins_age`. We pass three additional parameters, `data.by.week` to return the epidemiological curve out of window of action of nowcasting estimate and `return.age` to inform we desire a nowcasting result in two ways, the total aggregation estimate and the age-stratified estimate. The calling of the function has the following form:

```{r nowcasting}
nowcasting_bh_age<-nowcasting_inla(dataset = data, 
                                   bins_age = "10 years",
                                   data.by.week = T, 
                                   age_col = Idade)
```

Each of the estimates returned by `nowcasting_inla` has the same form as in the non-structured case, on the nowcasting estimates it returns a data.frame with the Median and its CI by credibility of 50% (LIb and LSb) and 95% (LI and LS).

```{r plot}
library(ggplot2)

dados_by_week<-nowcasting_bh_age$dados %>% 
  filter(DT_SIN_PRI >= (Sys.Date()-270)) %>% 
  group_by(DT_SIN_PRI) %>% 
  summarise(n = n())


nowcasting_bh_age$total %>% 
  ggplot(aes(x = dt_event, y = Median, col = 'Median'))+
  geom_line()+
  geom_line(data = dados_by_week, aes(DT_SIN_PRI, y = n))+
  geom_ribbon(aes(ymin = LI, ymax = LS, col = 'IC'), alpha = 0.2)+
  theme_bw()+
  theme(legend.position = "bottom", axis.text.x = element_text(angle = 90))+
  scale_color_manual(values = c('grey90', 'black'), name = '')+
  scale_x_date(date_breaks = '2 weeks', date_labels = '%V/%y', name = 'Date in Weeks')+
  labs(x = '', y = 'Nº Cases')
```

## Comparing the estimates

We can compare the estimates by each of the strategies, we plot the two estimates together:

```{r compare_plot}
nowcasting_bh_no_age$total$type<-"No Age structured"
nowcasting_bh_age$total$type<-"Age structured"


nowcasting_bh_total<-nowcasting_bh_age$total %>% 
  full_join(nowcasting_bh_no_age$total)

nowcasting_bh_total %>% 
  ggplot(aes(x = dt_event, y = Median, col = type))+
  geom_line(show.legend = F)+
  geom_ribbon(aes(ymin = LI, ymax = LS, fill = NULL), alpha = 0,
              show.legend = T)+
  # geom_line(data = dados_by_week, aes(DT_SIN_PRI, y = n))+
  theme_bw()+
  theme(legend.position = "bottom", axis.text.x = element_text(angle = 90))+
  scale_color_manual(values = c('grey60', 'grey90'), name = '')+
  scale_fill_manual(values = c('grey60', 'grey90'), name = '')+
  scale_x_date(date_breaks = '2 weeks', date_labels = '%V/%y', name = 'Date in Weeks')+
  labs(x = '', y = 'Nº Cases')
```

The estimates gives different CIs, this is due to a better fitting when considering random effects by age class for the delays at time, this has to do with the different capability to respond on different ages. This is an empirical finding of this models.

```{r}
sessionInfo()
```
