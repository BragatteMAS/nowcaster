<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="nowcaster">
<title>Structured data • nowcaster</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.1.0/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.1.0/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.rawgit.com/afeld/bootstrap-toc/v1.0.1/dist/bootstrap-toc.min.js"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Structured data">
<meta property="og:description" content="nowcaster">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-dark navbar-expand-lg bg-primary"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">nowcaster</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.2.0</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item">
  <a class="nav-link" href="../articles/nowcaster.html">Get started</a>
</li>
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="active nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-articles">Articles</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-articles">
    <a class="dropdown-item" href="../articles/forecasting.html">Forecasting</a>
    <a class="dropdown-item" href="../articles/nowcasting_importance.html">Nowcasting for decision making</a>
    <a class="dropdown-item" href="../articles/structured_data.html">Structured data</a>
  </div>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav">
<li class="nav-item">
  <a class="external-link nav-link" href="https://github.com/covid19br/nowcaster/" aria-label="github">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>

    
  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main"><div class="page-header">
      <img src="" class="logo" alt=""><h1>Structured data</h1>
                        <h4 data-toc-skip class="author">Rafael Lopes
&amp; Leonardo Bastos</h4>
            
      
      <small class="dont-index">Source: <a href="https://github.com/covid19br/nowcaster/blob/HEAD/vignettes/articles/structured_data.Rmd" class="external-link"><code>vignettes/articles/structured_data.Rmd</code></a></small>
      <div class="d-none name"><code>structured_data.Rmd</code></div>
    </div>

    
    
<p>As in the Get Started we start by loading the package and its lazy
data, by:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://covid19br.github.io/nowcaster">nowcaster</a></span><span class="op">)</span>
<span class="co"># Loading Belo Horizonte SARI dataset</span>
<span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="va">sragBH</span><span class="op">)</span></code></pre></div>
<div class="section level2">
<h2 id="non-structured-data">Non-structured data<a class="anchor" aria-label="anchor" href="#non-structured-data"></a>
</h2>
<p>Th Get Started example it is a non-strucutured data estimation, here
we give a more detailed on the description of this type of data and how
it can change the nowcasting estimation.</p>
<p>Now we call the nowcasting function, it has by default the
parametrization to take the data and estimate with a non-structured data
form. The estimate fits a negative binomial distribution, <span class="math inline">\(NegBinom(\lambda_{t,d}, \phi)\)</span>, to the
cases count at time <span class="math inline">\(t\)</span> with delay
<span class="math inline">\(d\)</span>, <span class="math inline">\(\phi\)</span> is the dispersion parameter. The
rate <span class="math inline">\(\lambda_{t,d}\)</span> is then
parameterized in a log-linear format by a constant term added by
structured delay random effects and structured time random effects.
Hence, the model is given by the following:</p>
<p><span class="math display">\[\begin{equation}
Y_{t,d} \sim NegBinom(\lambda_{t,d}, \phi), \\
\log(\lambda_{t,d}) = \alpha + \beta_t + \gamma_d, \\
t=1,2,\ldots,T, \\ d=1,2,\ldots,D,
\end{equation}\]</span></p>
<p>where the intercept <span class="math inline">\(\alpha\)</span>
follows is Gaussian distribution with a very large variance, <span class="math inline">\(\beta_t\)</span> is follows a second order random
walk with precision <span class="math inline">\(\tau_\beta\)</span>,
<span class="math inline">\(\gamma_d\)</span> a first-order random walk
with precision <span class="math inline">\(\tau_\gamma\)</span>. The
model is then completed by INLA default prior distributions for <span class="math inline">\(\phi\)</span>, <span class="math inline">\(\tau_\beta\)</span>, and <span class="math inline">\(\tau_\gamma\)</span>. See nbinom, rw1 and rw2 INLA
help pages.</p>
<p>The call of the function is straightforward, it simply needs a
dataset as input, here the <code>LazyData</code> loaded in the namespace
of the package. The function has 3 mandatory parameters,
<code>dataset</code> for the parsing of the dataset to be nowcasted,
<code>date_onset</code> for parsing the column name which is the date of
onset of symptoms and <code>date_report</code> which parses the column
name for the date of report of the cases. Here this columns are
“DT_SIN_PRI” and “DT_DIGITA”, respectively.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">nowcasting_bh_no_age</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/nowcasting_inla.html">nowcasting_inla</a></span><span class="op">(</span>dataset <span class="op">=</span> <span class="va">sragBH</span>, 
                                        date_onset <span class="op">=</span> <span class="va">DT_SIN_PRI</span>, 
                                        date_report <span class="op">=</span> <span class="va">DT_DIGITA</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">nowcasting_bh_no_age</span><span class="op">$</span><span class="va">total</span><span class="op">)</span>
<span class="co">#&gt; <span style="color: #949494;"># A tibble: 6 × 7</span></span>
<span class="co">#&gt;    Time dt_event   Median    LI    LS   LIb   LSb</span>
<span class="co">#&gt;   <span style="color: #949494; font-style: italic;">&lt;int&gt;</span> <span style="color: #949494; font-style: italic;">&lt;date&gt;</span>      <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span>
<span class="co">#&gt; <span style="color: #BCBCBC;">1</span>    17 2021-12-13    625  621   633    623  627 </span>
<span class="co">#&gt; <span style="color: #BCBCBC;">2</span>    18 2021-12-20    695  688.  708    692  698.</span>
<span class="co">#&gt; <span style="color: #BCBCBC;">3</span>    19 2021-12-27    812  801   830    807  817 </span>
<span class="co">#&gt; <span style="color: #BCBCBC;">4</span>    20 2022-01-03    886  871   907.   880  893 </span>
<span class="co">#&gt; <span style="color: #BCBCBC;">5</span>    21 2022-01-10    819  798   845    811  826 </span>
<span class="co">#&gt; <span style="color: #BCBCBC;">6</span>    22 2022-01-17    632  609   660    623  641</span></code></pre></div>
<p>This calling will return only the nowcasting estimate and its
Confidence Interval (CI) for two different Credible interval,
<code>LIb</code> and <code>LSb</code> are the max and min CI,
respectively, with credibility of 50% and <code>LI</code> and
<code>LS</code> are the max and min CI, respectively, with credibility
of 95%.</p>
<p><code>nowcasting_inla</code> has the option to return the curve for
when the nowcasting estimate was set the window of action of the model,
if the <code>data.by.week</code> parameter is flagged as
<code>TRUE</code> it returns on the second element of the output list
the summarized data by week.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">nowcasting_bh_no_age</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/nowcasting_inla.html">nowcasting_inla</a></span><span class="op">(</span>dataset <span class="op">=</span> <span class="va">sragBH</span>, 
                                        date_onset <span class="op">=</span> <span class="va">DT_SIN_PRI</span>, 
                                        date_report <span class="op">=</span> <span class="va">DT_DIGITA</span>, 
                                        data.by.week <span class="op">=</span> <span class="cn">T</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">nowcasting_bh_no_age</span><span class="op">$</span><span class="va">data</span><span class="op">)</span>
<span class="co">#&gt; <span style="color: #949494;"># A tibble: 6 × 3</span></span>
<span class="co">#&gt;   date_report date_onset Delay</span>
<span class="co">#&gt;   <span style="color: #949494; font-style: italic;">&lt;date&gt;</span>      <span style="color: #949494; font-style: italic;">&lt;date&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span>
<span class="co">#&gt; <span style="color: #BCBCBC;">1</span> 2020-02-24  2020-02-03     3</span>
<span class="co">#&gt; <span style="color: #BCBCBC;">2</span> 2020-01-27  2020-01-13     2</span>
<span class="co">#&gt; <span style="color: #BCBCBC;">3</span> 2020-04-06  2020-03-23     2</span>
<span class="co">#&gt; <span style="color: #BCBCBC;">4</span> 2020-03-23  2020-03-16     1</span>
<span class="co">#&gt; <span style="color: #BCBCBC;">5</span> 2020-04-06  2020-03-09     4</span>
<span class="co">#&gt; <span style="color: #BCBCBC;">6</span> 2020-04-13  2020-03-30     2</span></code></pre></div>
<p>This element it is the counts of cases by the amount of delay. It is
known as the delay triangle, if we table the delay amount against the
data of onset of first symptoms, it can see how is the pattern of the
delay for the cases.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org" class="external-link">dplyr</a></span><span class="op">)</span>

<span class="va">data_triangle</span> <span class="op">&lt;-</span> <span class="va">nowcasting_bh_no_age</span><span class="op">$</span><span class="va">data</span> |&gt; 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">Delay</span> <span class="op">&lt;</span> <span class="fl">30</span><span class="op">)</span> |&gt; 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html" class="external-link">arrange</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/desc.html" class="external-link">desc</a></span><span class="op">(</span><span class="va">Delay</span><span class="op">)</span><span class="op">)</span>
<span class="va">delay_triangle</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/table.html" class="external-link">table</a></span><span class="op">(</span><span class="va">data_triangle</span><span class="op">$</span><span class="va">date_onset</span>, 
                      <span class="fu"><a href="https://rdrr.io/r/base/rev.html" class="external-link">rev</a></span><span class="op">(</span><span class="va">data_triangle</span><span class="op">$</span><span class="va">Delay</span><span class="op">)</span>,
                      dnn <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="st">"Date of Onset"</span>, <span class="st">"Delay"</span><span class="op">)</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">delay_triangle</span><span class="op">)</span>
<span class="co">#&gt;              Delay</span>
<span class="co">#&gt; Date of Onset  0  1  2  3  4  5  6  7  8  9 10 11 12 13 14 15 16 17 18 19 20 21</span>
<span class="co">#&gt;    2019-12-23  3  4  7  4  0  1  1  0  0  0  0  0  0  0  1  0  0  0  0  0  0  0</span>
<span class="co">#&gt;    2019-12-30  1  4 10  4  0  0  0  1  0  0  0  0  0  0  0  0  0  0  0  0  0  0</span>
<span class="co">#&gt;    2020-01-06  0  3  5  6  0  4  1  0  0  0  0  0  0  0  0  0  1  0  0  0  0  0</span>
<span class="co">#&gt;    2020-01-13  0  5 11  6  0  3  0  0  0  0  0  0  0  0  0  0  1  1  0  0  0  0</span>
<span class="co">#&gt;    2020-01-20  1  5  3  3  0  5  1  0  0  0  0  0  0  0  0  0  0  0  0  0  0  0</span>
<span class="co">#&gt;    2020-01-27  0  7  4  5  0  2  1  0  0  0  0  0  0  0  0  0  1  0  0  0  0  0</span>
<span class="co">#&gt;              Delay</span>
<span class="co">#&gt; Date of Onset 22 23 24 25 26 27 28 29</span>
<span class="co">#&gt;    2019-12-23  0  0  0  0  0  0  0  0</span>
<span class="co">#&gt;    2019-12-30  0  0  0  0  0  0  0  0</span>
<span class="co">#&gt;    2020-01-06  0  0  0  0  0  0  0  0</span>
<span class="co">#&gt;    2020-01-13  0  0  0  0  0  0  0  0</span>
<span class="co">#&gt;    2020-01-20  0  0  0  0  0  0  0  0</span>
<span class="co">#&gt;    2020-01-27  0  0  0  0  0  0  0  0</span></code></pre></div>
<p>We just look at the amount of cases with 30 weeks of delay or less,
it is the default maximum delay considered at nowcasting estimation.</p>
<p>If this element is groped by and summarized by the onset of symptoms
date, here <code>DT_SIN_PRI</code>, it is the epidemiological curve
observed. To example it, we plot the estimate and the epidemiological
curve all together.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span>

<span class="va">dados_by_week</span> <span class="op">&lt;-</span> <span class="va">nowcasting_bh_no_age</span><span class="op">$</span><span class="va">data</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">date_onset</span> <span class="op">&gt;=</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Sys.time.html" class="external-link">Sys.Date</a></span><span class="op">(</span><span class="op">)</span><span class="op">-</span><span class="fl">270</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">date_onset</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html" class="external-link">summarise</a></span><span class="op">(</span>n <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/context.html" class="external-link">n</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span>

<span class="va">nowcasting_bh_no_age</span><span class="op">$</span><span class="va">total</span> |&gt; 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">dt_event</span>, y <span class="op">=</span> <span class="va">Median</span>, col <span class="op">=</span> <span class="st">'Nowcasting'</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">dados_by_week</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span><span class="va">date_onset</span>, y <span class="op">=</span> <span class="va">n</span>, col <span class="op">=</span> <span class="st">'Observed'</span><span class="op">)</span><span class="op">)</span><span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_ribbon.html" class="external-link">geom_ribbon</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>ymin <span class="op">=</span> <span class="va">LI</span>, ymax <span class="op">=</span> <span class="va">LS</span>, col <span class="op">=</span> <span class="cn">NA</span><span class="op">)</span>, alpha <span class="op">=</span> <span class="fl">0.2</span>, show.legend <span class="op">=</span> <span class="cn">F</span><span class="op">)</span><span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span><span class="op">)</span><span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_bw</a></span><span class="op">(</span><span class="op">)</span><span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>legend.position <span class="op">=</span> <span class="st">"bottom"</span>, axis.text.x <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>angle <span class="op">=</span> <span class="fl">90</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html" class="external-link">scale_color_manual</a></span><span class="op">(</span>values <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'grey50'</span>, <span class="st">'black'</span><span class="op">)</span>, name <span class="op">=</span> <span class="st">''</span><span class="op">)</span><span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_date.html" class="external-link">scale_x_date</a></span><span class="op">(</span>date_breaks <span class="op">=</span> <span class="st">'2 weeks'</span>, date_labels <span class="op">=</span> <span class="st">'%V/%y'</span>, name <span class="op">=</span> <span class="st">'Date in Weeks'</span><span class="op">)</span><span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>x <span class="op">=</span> <span class="st">''</span>, y <span class="op">=</span> <span class="st">'Nº Cases'</span><span class="op">)</span></code></pre></div>
<p><img src="structured_data_files/figure-html/no_age_plot-1.png" width="700"></p>
</div>
<div class="section level2">
<h2 id="structured-data-age">Structured data, Age<a class="anchor" aria-label="anchor" href="#structured-data-age"></a>
</h2>
<p>For the structured data the <code><a href="../reference/nowcasting_inla.html">nowcasting_inla()</a></code> fits again
a Negative binomial distribution to the cases count at time <span class="math inline">\(t\)</span> with delay <span class="math inline">\(d\)</span>. Differently, from the non-structured
case the model now gives random effects to the delay distribution and
and time distribution by each of the age-class chosen by the user to
break the data. The model has the form now:</p>
<p><span class="math display">\[\begin{equation}Y_{t,d,a}
\sim  NegBinom(\lambda_{t,d,a}, \phi), \\
\log(\lambda_{t,d,a}) =  \alpha_a + \beta_{t,a} + \gamma_{d,a}, \\ \quad
t=1,2,\ldots,T, \\ d=1,2,\ldots,D, \\ a=1,2,\ldots,A,
\end{equation}\]</span></p>
<p>where each age class, <span class="math inline">\(a\)</span>, has an
intercept <span class="math inline">\(\alpha_a\)</span> following a
Gaussian distribution with a very large variance, the time-age random
effects, <span class="math inline">\(\beta_{t,a}\)</span>, follow a
joint multivariate Gaussian distribution with a separable variance
components an independent Gaussian term for the age classes with
precision <span class="math inline">\(\tau_{age,\beta}\)</span> and a
second order random walk term for the time with precision <span class="math inline">\(\tau_{\beta}\)</span>. Analogously, the delay-age
random effects, <span class="math inline">\(\gamma_{d,a}\)</span>,
follow a joint multivariate Gaussian distribution with a separable
variance components an independent Gaussian term for the age classes
with precision <span class="math inline">\(\tau_{age,\gamma}\)</span>
and a first order random walk term for the time with precision <span class="math inline">\(\tau_{\gamma}\)</span>. The model is then
completed by INLA default prior distributions for <span class="math inline">\(\phi\)</span>, <span class="math inline">\(\tau_{age,\beta}\)</span>, <span class="math inline">\(\tau_{age,\gamma}\)</span>, <span class="math inline">\(\tau_{\beta}\)</span> and <span class="math inline">\(\tau_\gamma\)</span>. See nbinom, iid, rw1 and rw2
INLA help pages.</p>
<p>This new model corrects the delay taking into account the effects of
age classes and the interactions of each age class between time and also
delay. Now the model needs a flag indicating which is the column on the
dataset which will be used to break the data into age classes and how
the age classes will be split. This is given by the parameters
<code>age_col</code> and <code>bins_age</code>. We pass three additional
parameters, <code>data.by.week</code> to return the epidemiological
curve out of window of action of nowcasting estimate and
<code>return.age</code> to inform we desire a nowcasting result in two
ways, the total aggregation estimate and the age-stratified estimate.
The calling of the function has the following form:</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">nowcasting_bh_age</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/nowcasting_inla.html">nowcasting_inla</a></span><span class="op">(</span>dataset <span class="op">=</span> <span class="va">sragBH</span>, 
                                   bins_age <span class="op">=</span> <span class="st">"10 years"</span>,
                                   data.by.week <span class="op">=</span> <span class="cn">T</span>, 
                                   date_onset <span class="op">=</span> <span class="va">DT_SIN_PRI</span>, 
                                   date_report <span class="op">=</span> <span class="va">DT_DIGITA</span>,
                                   age_col <span class="op">=</span> <span class="va">Idade</span><span class="op">)</span></code></pre></div>
<p>Each of the estimates returned by <code>nowcasting_inla</code> has
the same form as in the non-structured case. On the nowcasting
estimates, it returns a data.frame with the posterior edian and 50% and
95% credible intervals, (LIb and LSb) and (LI and LS) respectively.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span>

<span class="va">dados_by_week</span> <span class="op">&lt;-</span> <span class="va">nowcasting_bh_age</span><span class="op">$</span><span class="va">data</span> |&gt; 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">date_onset</span> <span class="op">&gt;=</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Sys.time.html" class="external-link">Sys.Date</a></span><span class="op">(</span><span class="op">)</span><span class="op">-</span><span class="fl">270</span><span class="op">)</span><span class="op">)</span> |&gt;  
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">date_onset</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html" class="external-link">summarise</a></span><span class="op">(</span>n <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/context.html" class="external-link">n</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span>


<span class="va">nowcasting_bh_age</span><span class="op">$</span><span class="va">total</span> |&gt; 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">dt_event</span>, y <span class="op">=</span> <span class="va">Median</span>, col <span class="op">=</span> <span class="st">'Median'</span><span class="op">)</span><span class="op">)</span><span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span><span class="op">)</span><span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">dados_by_week</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span><span class="va">date_onset</span>, y <span class="op">=</span> <span class="va">n</span><span class="op">)</span><span class="op">)</span><span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_ribbon.html" class="external-link">geom_ribbon</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>ymin <span class="op">=</span> <span class="va">LI</span>, ymax <span class="op">=</span> <span class="va">LS</span>, col <span class="op">=</span> <span class="st">'IC'</span><span class="op">)</span>, alpha <span class="op">=</span> <span class="fl">0.2</span><span class="op">)</span><span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_bw</a></span><span class="op">(</span><span class="op">)</span><span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>legend.position <span class="op">=</span> <span class="st">"bottom"</span>, axis.text.x <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>angle <span class="op">=</span> <span class="fl">90</span><span class="op">)</span><span class="op">)</span><span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html" class="external-link">scale_color_manual</a></span><span class="op">(</span>values <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'grey90'</span>, <span class="st">'black'</span><span class="op">)</span>, name <span class="op">=</span> <span class="st">''</span><span class="op">)</span><span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_date.html" class="external-link">scale_x_date</a></span><span class="op">(</span>date_breaks <span class="op">=</span> <span class="st">'2 weeks'</span>, date_labels <span class="op">=</span> <span class="st">'%V/%y'</span>, name <span class="op">=</span> <span class="st">'Date in Weeks'</span><span class="op">)</span><span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>x <span class="op">=</span> <span class="st">''</span>, y <span class="op">=</span> <span class="st">'Nº Cases'</span><span class="op">)</span></code></pre></div>
<p><img src="structured_data_files/figure-html/plot-1.png" width="700"></p>
</div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p></p>
<p>Developed by <a href="https://github.com/lsbastos/" class="external-link">Leonardo Bastos</a>, <a href="https://github.com/rafalopespx" class="external-link">Rafael Lopes</a>.</p>
</div>

<div class="pkgdown-footer-right">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.3.</p>
</div>

    </footer>
</div>

  

  

  </body>
</html>
